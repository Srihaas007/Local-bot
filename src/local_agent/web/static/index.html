<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Local Agent UI</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 0; display: flex; height: 100vh; }
    #sidebar { width: 280px; background:#1e1e1e; color:#eee; padding:16px; box-sizing:border-box; overflow-y:auto; }
    #main { flex:1; display:flex; flex-direction:column; }
    #messages { flex:1; padding:16px; overflow-y:auto; background:#fafafa; }
    .msg { margin:0 0 12px; padding:8px 12px; border-radius:8px; max-width:70%; line-height:1.4; }
    .user { background:#d0ebff; align-self:flex-end; }
    .assistant { background:#e2e2e2; }
    #inputBar { display:flex; gap:8px; padding:12px; border-top:1px solid #ccc; background:#fff; }
    #inputBar input[type=text] { flex:1; padding:8px; font-size:1rem; }
    button { cursor:pointer; }
    #searchBox { margin-top:12px; }
    #memoryHits { font-size:0.85rem; margin-top:8px; }
    #streamIndicator { font-size:0.75rem; color:#555; }
    #voiceControls { margin-top:24px; }
    .hit { background:#333; padding:6px 8px; border-radius:6px; margin-bottom:6px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>Local Agent</h2>
    <div id="searchBox">
      <input type="text" id="searchInput" placeholder="Search memory..." />
      <button id="searchBtn">Search</button>
      <div id="memoryHits"></div>
    </div>
    <div id="voiceControls">
      <h3>Voice</h3>
      <div>
        <label>Upload WAV for STT:</label><br/>
        <input type="file" id="sttFile" accept="audio/wav" />
        <button id="sttBtn">Transcribe</button>
      </div>
      <div style="margin-top:12px;">
        <input type="text" id="ttsInput" placeholder="Text to speak" />
        <button id="ttsBtn">Play TTS</button>
        <audio id="ttsAudio" controls style="display:none;"></audio>
      </div>
    </div>
  </div>
  <div id="main">
    <div id="messages"></div>
    <div id="inputBar">
      <input type="text" id="chatInput" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
      <button id="streamToggle">Streaming: ON</button>
    </div>
    <div id="streamIndicator"></div>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const streamToggle = document.getElementById('streamToggle');
    const memoryHits = document.getElementById('memoryHits');
    let streamingEnabled = true;

    function addMessage(text, role) {
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      div.textContent = text;
      div.setAttribute('data-role', role);
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function sendChat() {
      const msg = chatInput.value.trim();
      if (!msg) return;
      addMessage(msg, 'user');
      chatInput.value='';
      if (streamingEnabled) {
        streamChat(msg);
      } else {
        const resp = await fetch('/chat', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message: msg})});
        const data = await resp.json();
        addMessage(data.output, 'assistant');
      }
    }

    function streamChat(msg) {
      const indicator = document.getElementById('streamIndicator');
      indicator.textContent = 'Streaming...';
      let buffer = '';
      const es = new EventSource('/chat/stream?message=' + encodeURIComponent(msg));
      es.onmessage = (e) => {
        buffer += e.data;
        renderStreaming(buffer);
      };
      es.addEventListener('tool', (e) => {
        buffer += '\n' + JSON.parse(e.data).name + ' requested. Approve via CLI (not supported in UI yet).';
        renderStreaming(buffer);
      });
      es.addEventListener('done', () => {
        finalizeStreaming(buffer);
        indicator.textContent = '';
        es.close();
      });
      es.addEventListener('error', () => {
        finalizeStreaming(buffer + '\n[stream error]');
        indicator.textContent = '';
        es.close();
      });
    }

    function renderStreaming(text) {
      // Update or create streaming assistant message
      let last = messagesEl.querySelector('.msg.assistant[data-streaming="true"]');
      if (!last) {
        last = document.createElement('div');
        last.className = 'msg assistant';
        last.dataset.streaming = 'true';
        messagesEl.appendChild(last);
      }
      last.textContent = text;
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function finalizeStreaming(text) {
      let last = messagesEl.querySelector('.msg.assistant[data-streaming="true"]');
      if (last) {
        last.removeAttribute('data-streaming');
        last.textContent = text;
      } else {
        addMessage(text, 'assistant');
      }
    }

    sendBtn.addEventListener('click', sendChat);
    chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendChat(); });
    streamToggle.addEventListener('click', () => {
      streamingEnabled = !streamingEnabled;
      streamToggle.textContent = 'Streaming: ' + (streamingEnabled ? 'ON' : 'OFF');
    });

    // Memory search
    document.getElementById('searchBtn').addEventListener('click', async () => {
      const q = document.getElementById('searchInput').value.trim();
      if (!q) return; 
      const resp = await fetch('/memory/search?q=' + encodeURIComponent(q));
      const data = await resp.json();
      memoryHits.innerHTML = '';
      data.hits.forEach(h => {
        const d = document.createElement('div');
        d.className='hit';
        d.textContent = '[' + h.kind + '] ' + h.text;
        memoryHits.appendChild(d);
      });
    });

    // STT
    document.getElementById('sttBtn').addEventListener('click', async () => {
      const f = document.getElementById('sttFile').files[0];
      if (!f) return;
      const fd = new FormData();
      fd.append('file', f, f.name);
      const resp = await fetch('/stt', { method:'POST', body: fd });
      const data = await resp.json();
      addMessage('[STT] ' + (data.content || data.error), 'assistant');
    });

    // TTS
    document.getElementById('ttsBtn').addEventListener('click', async () => {
      const text = document.getElementById('ttsInput').value.trim();
      if (!text) return;
      const resp = await fetch('/tts?text=' + encodeURIComponent(text));
      if (!resp.ok) {
        addMessage('[TTS error] ' + (await resp.text()), 'assistant');
        return;
      }
      const blob = await resp.blob();
      const url = URL.createObjectURL(blob);
      const audio = document.getElementById('ttsAudio');
      audio.style.display='block';
      audio.src = url;
      audio.play();
    });
  </script>
</body>
</html>